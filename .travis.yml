# To create a release
#   git checkout master
#   git pull
# This may be needed
#   git tag -d 1.0.0; git push --delete origin 1.0.0
# modify version number in package.json in master branch
#   git checkout deploy
#   git pull
#   git rebase origin/master
#   git commit -a -m "Release"
#   git push
#   git checkout master

language: generic
os: linux
dist: xenial
env:
  global:
    - npm_ver=`node -p "require('./package.json').version"`

before_install:
  - npm install
  - npm cache clean --force

script:
  - npm test

jobs:
  include:
    # - os: linux
    #   language: node_js
    #   node_js: "6.16"
    #   python: "2.7"
    #   branches:
    #      only: master

    - os: windows
      language: node_js
      node_js: "8.11.3"
      python: "2.7"
      branches:
        only: master

    # - os: osx
    #   language: node_js
    #   node_js: "6.16"
    #   python: "2.7"
    #   branches:
    #     only: master

    - stage: deploy
      if: branch = deploy
      os: osx
      language: generic
      before_install: skip
      script: skip
      branches:
        only:
          deploy

      before_deploy:
        - git config --local user.name "rweigel"
        - git config --local user.email "rweigel@gmu.edu"
        - npm i
        - cd pkg && make update
        - export TRAVIS_TAG=$npm_ver
        - git tag $npm_ver

      deploy:
        provider: releases
        on:
          branch: deploy
        api_key: $GITHUB_OAUTH_TOKEN
        file_glob: true
        file: dist/*
        skip_cleanup: true

    # - stage: darwin-x64
    #   os: osx
    #   language: generic
    #   before_install: skip
    #   branches:
    #     only:
    #       - deploy
    #   script: curl -O -L https://github.com/hapi-server/server-nodejs/releases/download/$npm_ver/hapi-server-$npm_ver-darwin-x64.tgz && tar zxf hapi-server-$npm_ver-darwin-x64.tgz && cd hapi-server-$npm_ver && ./hapi-server test;

    # - stage: linux-armv7l
    #   os: osx
    #   language: generic
    #   before_install: skip
    #   branches:
    #     only:
    #       - deploy
    #   script: curl -O -L https://github.com/hapi-server/server-nodejs/releases/download/$npm_ver/hapi-server-$npm_ver-linux-armv7l.tgz && tar zxf hapi-server-$npm_ver-linux-armv7l.tgz && cd hapi-server-$npm_ver && ./hapi-server test;

    # - stage: linux-x64
    #   os: osx
    #   language: generic
    #   before_install: skip
    #   branches:
    #     only:
    #       - deploy
    #   script: curl -O -L https://github.com/hapi-server/server-nodejs/releases/download/$npm_ver/hapi-server-$npm_ver-linux-x64.tgz && tar zxf hapi-server-$npm_ver-linux-x64.tgz && cd hapi-server-$npm_ver && ./hapi-server test;

    - stage: win-x64
      os: windows
      before_install: skip
      branches:
        only:
          - deploy
      script: curl -O -L https://github.com/hapi-server/server-nodejs/releases/download/$npm_ver/hapi-server-$npm_ver-win-x64.tgz; tar zxf hapi-server-$npm_ver-win-x64.tgz; cd hapi-server-$npm_ver; ./hapi-server test;

notifications:
  email:
    recipients:
      - ksreddy9945@gmail.com
      - rweigel@gmu.edu
  on_success: change
  on_failure: always
